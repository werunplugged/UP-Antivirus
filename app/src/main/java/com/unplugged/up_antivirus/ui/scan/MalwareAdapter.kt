package com.unplugged.up_antivirus.ui.scan

import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Button
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView
import com.unplugged.antivirus.R
import com.unplugged.up_antivirus.base.Utils
import com.unplugged.upantiviruscommon.malware.MalwareModel
import com.unplugged.upantiviruscommon.malware.ThreatStatus
import java.util.Locale

class MalwareAdapter(
    private val clickListener: (malware: MalwareModel) -> Unit,
    private val actionClickListener: (malware: MalwareModel) -> Unit,
    private val malwares: MutableList<MalwareModel> = mutableListOf()
) : RecyclerView.Adapter<RecyclerView.ViewHolder>() {

    companion object {
        private const val VIEW_TYPE_RESULT = 1
        private const val VIEW_TYPE_NO_RESULTS = 0
    }

    private var filteredMalwares: MutableList<MalwareModel> = malwares.toMutableList()

    inner class ThreadHolder(view: View) : RecyclerView.ViewHolder(view) {
        val nameTv: TextView = view.findViewById(R.id.app_name)
        val descriptionTv: TextView = view.findViewById(R.id.description_tv)
        val actionBtn: Button = view.findViewById(R.id.action_btn)
    }

    inner class NoResultsViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView)

    override fun getItemViewType(position: Int): Int {
        return if (filteredMalwares.isEmpty()) VIEW_TYPE_NO_RESULTS else VIEW_TYPE_RESULT
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): RecyclerView.ViewHolder {
        return if (viewType == VIEW_TYPE_RESULT) {
            val view = LayoutInflater.from(parent.context).inflate(R.layout.threat_item, parent, false)
            ThreadHolder(view)
        } else {
            val view = LayoutInflater.from(parent.context).inflate(R.layout.no_malware_found_item, parent, false)
            NoResultsViewHolder(view)
        }
    }

    override fun onBindViewHolder(holder: RecyclerView.ViewHolder, position: Int) {
        if (holder is ThreadHolder) {
            val malware = filteredMalwares[position]
            holder.nameTv.text = malware.name
            holder.descriptionTv.text = if (malware.filePath == MalwareModel.BLACK_LIST_PACKAGE) {
                holder.itemView.context.getString(R.string.up_av_potentially_harmful_application, malware.description)
            } else malware.description

            val actionButtonText = when (malware.status) {
                ThreatStatus.EXIST -> {
                    holder.actionBtn.isEnabled = true
                    "Remove"
                }

                ThreatStatus.PENDING -> {
                    holder.actionBtn.isEnabled = false
                    "Removing.."
                }

                ThreatStatus.REMOVED -> {
                    holder.actionBtn.isEnabled = false
                    "Deleted"
                }

                ThreatStatus.FAILED -> {
                    holder.actionBtn.isEnabled = true
                    "Try Again"
                }
            }

            holder.actionBtn.text = actionButtonText

            holder.itemView.setOnClickListener {
                clickListener(malware)
            }

            holder.actionBtn.setOnClickListener {
                actionClickListener(malware)
            }
        } else if (holder is NoResultsViewHolder) {
            // Nothing to bind here since the text is already set in XML
        }
    }

    override fun getItemCount(): Int {
        return if (filteredMalwares.isEmpty()) 1 else filteredMalwares.size
    }

    fun setMalwares(malwares: List<MalwareModel>) {
        this.malwares.clear()
        this.malwares.addAll(malwares)
        this.filteredMalwares = this.malwares.toMutableList()
        notifyDataSetChanged()
    }

    fun addMalware(malware: MalwareModel) {
        Utils.printLog(MalwareAdapter::class.java, "addMalware -> ${malware.filePath}")
        this.malwares.add(0, malware)
        this.filteredMalwares.add(0, malware)
        notifyItemInserted(0)
    }

    fun updateMalware(malware: MalwareModel) {
        val position = filteredMalwares.indexOf(malware)

        if (malware.status == ThreatStatus.PENDING || malware.status == ThreatStatus.FAILED) {
            notifyItemChanged(position)
        }

        if (malware.status == ThreatStatus.REMOVED) {
            this.malwares.remove(malware)
            this.filteredMalwares.remove(malware)
            notifyItemRemoved(position)
        }
    }

    fun filter(query: String?) {
        val lowerCaseQuery = query?.lowercase(Locale.getDefault())
        filteredMalwares = if (lowerCaseQuery.isNullOrEmpty()) {
            malwares.toMutableList()
        } else {
            malwares.filter {
                it.name.lowercase(Locale.getDefault()).contains(lowerCaseQuery)
            }.toMutableList()
        }
        notifyDataSetChanged()
    }
}